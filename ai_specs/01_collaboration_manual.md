# Halo 插件开发 AI 协作全流程规范手册 (Halo Plugin Development Spec)

**版本**：1.0.0  
**适用对象**：AI 辅助编码工具、人类开发者、技术负责人  
**生效范围**：Halo 2.x 及以上版本插件项目

---

## 1. 插件立项规范

### 1.1 插件定位与目标
- **核心原则**：Halo 插件应当是“非侵入式”的扩展。
- **定位分类**：
    - **功能增强型**：增加新的业务逻辑（如：工单系统、活动报名）。
    - **服务集成型**：对接第三方服务（如：OSS 存储、短信服务、OAuth 登录）。
    - **主题辅助型**：为主题提供特定的数据接口（Finder）或标签。
    - **管理增强型**：优化 Console 管理后台体验（如：批量操作工具）。

### 1.2 适用场景判断标准
若满足以下任一条件，**不适合**做成 Halo 插件，应考虑独立部署服务：
- 需要极高并发处理能力，且 Halo 主进程资源受限。
- 需要修改 Halo 核心（Core）源码或数据库表结构（非 Extension 扩展表）。
- 依赖极为复杂的外部环境，且无法容器化。

### 1.3 立项检查清单 (Checklist)
- [ ] 目标功能是否可以通过 Halo 现有的扩展点（Extension Points）实现？
- [ ] 是否确认了 Halo 的最低版本依赖（`spec.requires`）？
- [ ] 插件 ID（`metadata.name`）是否符合反向域名规范（如 `run.halo.plugin.todo`）且未被占用？
- [ ] 技术栈是否锁定为 Java 17+ 和 Console UI (Vue 3)？

---

## 2. 需求提出（提需）规范

### 2.1 需求来源分类
- **F-User (用户需求)**：最终用户可见的功能特性。
- **F-Ops (运维需求)**：配置管理、日志监控、数据迁移。
- **T-Opt (技术优化)**：代码重构、性能提升、依赖升级。
- **E-Hot (紧急需求)**：线上 Bug 修复、安全漏洞修补。

### 2.2 标准需求模板
**AI 提示词**：当人类提出模糊需求时，AI 必须要求人类按此模板补充。

```markdown
## [F-User] 需求名称：<简短描述>

### 1. 核心价值 (User Story)
作为 <角色>，我想要 <功能>，以便于 <达成什么目的>。

### 2. 详细交互流程
1. 用户在菜单点击 A。
2. 系统展示 B 列表。
3. ...

### 3. Halo 集成点 (关键)
- **菜单入口**：是否需要在 Console 左侧菜单展示？
- **扩展点**：是否利用了特定的 UI 扩展点（如文章编辑器侧边栏）？
- **数据存储**：是否需要定义新的自定义模型 (Extension/Custom Resource)？

### 4. 验收标准 (Acceptance Criteria)
- [ ] 正常流程通过。
- [ ] 异常流程（如网络失败）有提示。
- [ ] 权限控制生效（未授权用户不可见）。
```

### 2.3 AI 协助补全规则
- **场景**：用户只说“我要个打卡插件”。
- **AI 动作**：
    1.  **推断**：询问是否需要后台管理记录？是否需要前台展示？
    2.  **建议**：建议定义 `CheckIn` 模型，包含 `userId`, `checkInTime` 字段。
    3.  **生成**：自动生成上述 Markdown 模板草稿供用户确认。

---

## 3. 需求评审与确认流程

### 3.1 技术可行性评审
- **扩展点匹配**：需求是否正好对应 Halo 的 `ExtensionPoint`？
- **WebFlux 兼容性**：确认依赖的第三方库是否支持非阻塞 I/O。

### 3.2 决策标准
- **Go**：需求清晰，扩展点明确，无破坏性变更。
- **Hold**：Halo 当前版本不支持该扩展能力，需等待 Halo 升级。
- **No-Go**：严重违反安全规范或架构原则。

---

## 4. 需求拆解与开发计划

### 4.1 拆解原则
- **垂直切片**：尽量按“端到端”拆解（Extension 定义 -> Reconciler 逻辑 -> UI 界面）。

### 4.2 Halo 插件结构级拆解
1.  **Model Task**：定义 `extension/v1alpha1/MyKind.java`。
2.  **Logic Task**：编写 `MyKindReconciler` 或 `Service`。
3.  **API Task**：自定义 Controller (RouterFunction)。
4.  **UI Task**：编写 Console 前端组件及路由配置。

---

## 5. 需求变更与临时插入需求处理规范

### 5.1 变更分类
- **轻微变更**：UI 调整。AI 直接修正。
- **中等变更**：字段增减。必须先修改 Extension 模型并检查兼容性。
- **重大变更**：重构架构。回到「需求提出」阶段。

### 5.2 AI 行为约束
- **必须**：接收变更时，必须复述内容并评估对已有模块的影响。

---

## 6. 编码规范 (核心)
（详情参见 `ai_specs/00_master_spec.md`）

---

## 7. 自测与测试规范

### 7.1 单元测试要求
- 核心业务逻辑覆盖率 > 80%。
- 使用 `@ExtendWith(MockitoExtension.class)` 进行 Mock 测试。

### 7.2 AI 生成测试用例
- 必须为每一个 `Reconciler` 生成状态变更测试用例。

---

## 8. 插件构建、打包与发布规范

### 8.1 构建流程
- `./gradlew clean build`
- 产物：`build/libs/*.jar`

### 8.2 发布前检查
- [ ] `plugin.yaml` 版本约束。
- [ ] 权限控制是否生效。
- [ ] 静态资源是否正确打包。

---

## 9. 文档与交付物规范
- 必须输出：`README.md`, `CHANGELOG.md`。
- AI 需自动生成 JavaDoc 和配置说明表。

---

## 10. 插件维护与迭代规范
- AI 可以分析异常堆栈和解释逻辑。
- 禁止在无测试用例保护的情况下进行大规模重构。
